'use server';

import { NextRequest, NextResponse } from 'next/server';
import { getModel, callGeminiWithRetry, parseJSONResponse } from '@/lib/ai/gemini';

interface GenerateContextExamplesRequest {
  category: string;
  categoryName: string;
}

interface GenerateContextExamplesResponse {
  examples: string[];
}

// 카테고리별 제품 스펙 힌트 (뭘 살지 아는 사람용) - 구체적인 불만/요구사항
const CATEGORY_SPEC_HINTS: Record<string, string> = {
  milk_powder_port: '쿨링 기능, 소음 문제, 온도 정확도, 세척 편의성, 용량',
  formula_pot: '쿨링 기능, 소음 문제, 온도 정확도, 세척 편의성, 용량',
  baby_bottle: '배앓이 방지, 젖꼭지 단계, 소재(PPSU/유리), 용량(160ml/260ml)',
  car_seat: '회전형, ISOFIX, 신생아~몇세용, 각도 조절, 통풍',
  stroller: '한손 접이, 무게(경량/디럭스), 바퀴 크기, 양대면',
  diaper: '흡수력, 새는 문제, 단계(3단계/4단계), 두께, 통기성',
  high_chair: '접이식, 높이 조절, 트레이 분리, 바퀴 유무',
  thermometer: '비접촉/귀체온, 측정 속도, 정확도',
  baby_wipes: '두께, 엠보싱, 성분(무향/저자극), 캡 타입',
  formula: '소화력, 분유 타입(일반/HA/산양), 변비/설사 문제',
  pacifier: '교정용, 실리콘/천연고무, 크기(0-6개월/6개월+)',
  baby_bed: '높이 조절, 이동식, 범퍼 포함, 크기',
  baby_sofa: '세탁 가능, 안전벨트, 크기',
};

// 카테고리별 상황 힌트 (첫 구매자용) - 구체적인 상황 정보
const CATEGORY_SITUATION_HINTS: Record<string, string> = {
  milk_powder_port: '아기 월령(3개월/6개월 등), 하루 수유 횟수, 밤수유 빈도, 분유 브랜드',
  formula_pot: '아기 월령(3개월/6개월 등), 하루 수유 횟수, 밤수유 빈도, 분유 브랜드',
  baby_bottle: '아기 월령, 모유/분유/혼합, 한 번 수유량(ml), 젖병 거부 여부',
  car_seat: '아기 월령/체중(kg), 차종(SUV/세단/소형), 장거리 빈도, 카시트 경험',
  stroller: '아기 월령, 주거형태(아파트 몇층/엘베 유무), 대중교통 이용, 차 트렁크 크기',
  diaper: '아기 월령/체중(kg), 성별, 피부 민감도, 활동량(뒤집기/기기 등)',
  high_chair: '아기 월령, 이유식 시작 여부, 식탁 높이, 주방 공간',
  thermometer: '아기 월령, 열 자주 나는지, 측정 경험',
  baby_wipes: '아기 월령, 피부 타입(민감/아토피), 주 용도(기저귀/손입)',
  formula: '아기 월령, 모유→분유 전환, 소화 문제, 알레르기 가족력',
  pacifier: '아기 월령, 모유/분유 수유, 공갈 경험',
  baby_bed: '아기 월령, 방 크기, 부모 침대 옆/독립 방, 이동 필요',
  baby_sofa: '아기 월령, 혼자 앉기 가능 여부, 형제 유무',
};

export async function POST(request: NextRequest) {
  try {
    const body: GenerateContextExamplesRequest = await request.json();
    const { category, categoryName } = body;

    const specHints = CATEGORY_SPEC_HINTS[category] || '용량, 소음, 편의성, 가격대';
    const situationHints = CATEGORY_SITUATION_HINTS[category] || '아기 월령, 사용 환경, 생활 패턴';

    const systemPrompt = `당신은 육아 전문 상담사입니다.

${categoryName}을 구매하려는 부모가 **추천 서비스에 처음 입력할 법한 문장** 6개를 생성해주세요.
이것은 추천의 "시작점"이므로, 사용자의 상황과 요구사항을 아주 **구체적이고 상세하게** 담아야 합니다.

## 세 가지 유형의 예시 (각 2개씩):

### 유형 A: 현재 불편/문제점 (2개)
- 지금 쓰는 제품의 **매우 구체적인 불만** 또는 **해결하고 싶은 문제**를 묘사하세요.
- 관련 스펙: ${specHints}

### 유형 B: 아기/가족 상황 (2개)
- **월령, 체중, 완분/완모 여부, 가족의 생활 패턴, 주거 환경** 등 구체적 정보를 조합하세요.
- 관련 정보: ${situationHints}

### 유형 C: 원하는 특징/조건 (2개)
- 단순히 '가성비'가 아니라, **왜 그 특징이 필요한지** 이유를 포함한 구체적인 조건

## 중요 규칙:
1. **"~추천해주세요" 금지** - 상황만 설명하세요.
2. **물음표(?) 금지**
3. 문장 끝맺음: "~원해요", "~필요해요", "~예요", "~이에요", "~있어요", "~중요해요", "~힘들어요", "~찾아요"
4. 각 예시는 **30~50자 내외**로 아주 구체적으로 작성하세요. (단순한 단어 나열 금지)
5. 6개 예시가 서로 중복되지 않게 상황을 다양하게 설정하세요.`;

    const userPrompt = `**카테고리:** ${categoryName} (${category})

${categoryName} 추천 서비스에 사용자가 **처음 입력할 구체적이고 생생한 상황/조건** 6개를 생성하세요.
단순히 "무거워요", "4개월이에요" 같은 짧은 문장이 아니라, 실제 부모들이 겪는 **디테일한 상황**을 묘사해야 합니다.

유형 A(불편/문제점) 2개, 유형 B(아기/가족 상황) 2개, 유형 C(원하는 특징) 2개씩 균형있게 생성하세요.
"~추천해주세요" 형태는 절대 금지입니다.

**응답 형식 (JSON):**
{
  "examples": [
    "지금 쓰는 분유 포트 물 끓는 소리가 너무 커서 밤수유 때 아기가 깨서 힘들어요",
    "밤 기저귀가 자꾸 새서 아침마다 이불 빨래하는 게 너무 지치고 힘들어요",
    "생후 130일 7.2kg 완분 아기인데 수유량이 늘어서 큰 사이즈 젖병이 필요해요",
    "엘리베이터 없는 빌라 3층에 살아서 무조건 가볍고 휴대하기 편한 모델 원해요",
    "맞벌이라 세척에 시간을 많이 못 써서 구조가 단순하고 통세척 되는 거 찾아요",
    "밤에 아기 잘 때 준비해야 해서 소음이 거의 없고 불빛이 은은한 제품 원해요"
  ]
}`;

    const model = getModel(0.7);

    const response = await callGeminiWithRetry(async () => {
      const result = await model.generateContent([
        { text: systemPrompt },
        { text: userPrompt },
      ]);
      return result.response.text();
    });

    const parsed = parseJSONResponse<GenerateContextExamplesResponse>(response);

    // 카테고리별 기본 예시 (9개) - 유형별 3개씩
    const defaultExamples: Record<string, string[]> = {
      milk_powder_port: [
        // 유형 A: 불편/문제점
        '지금 쓰는 포트 물 끓는 소리가 너무 커서 밤수유 때 아기가 깨서 힘들어요',
        '온도 조절이 정확하지 않아서 분유 탈 때마다 온도를 다시 재야 해요',
        '구조가 복잡해서 구석구석 세척하기가 너무 번거롭고 위생이 걱정돼요',
        // 유형 B: 아기/가족 상황
        '생후 90일 6.5kg 아기이고 밤수유를 하루에 3번 이상 하고 있어요',
        '쌍둥이라 한 번에 많은 양의 물을 빠르게 데워야 하는 상황이에요',
        '맞벌이라 새벽 수유 준비 시간을 최대한 단축하고 싶은 부모예요',
        // 유형 C: 원하는 특징
        '손이 끝까지 들어가서 시원하게 통세척 할 수 있는 제품이 필요해요',
        '원하는 온도까지 빠르게 내려주는 쿨링 기능이 강력했으면 좋겠어요',
        '기능은 기본에 충실하면서 가격 부담 없는 가성비 모델을 찾고 있어요',
      ],
      formula_pot: [
        '지금 쓰는 포트 물 끓는 소리가 너무 커서 밤수유 때 아기가 깨서 힘들어요',
        '온도 조절이 정확하지 않아서 분유 탈 때마다 온도를 다시 재야 해요',
        '구조가 복잡해서 구석구석 세척하기가 너무 번거롭고 위생이 걱정돼요',
        '생후 90일 6.5kg 아기이고 밤수유를 하루에 3번 이상 하고 있어요',
        '쌍둥이라 한 번에 많은 양의 물을 빠르게 데워야 하는 상황이에요',
        '맞벌이라 새벽 수유 준비 시간을 최대한 단축하고 싶은 부모예요',
        '손이 끝까지 들어가서 시원하게 통세척 할 수 있는 제품이 필요해요',
        '원하는 온도까지 빠르게 내려주는 쿨링 기능이 강력했으면 좋겠어요',
        '기능은 기본에 충실하면서 가격 부담 없는 가성비 모델을 찾고 있어요',
      ],
      car_seat: [
        '지금 쓰는 카시트는 각도 조절이 세밀하지 않아서 아이 목이 자꾸 꺾여요',
        '시트 소재가 답답한지 조금만 타도 아이 등에 땀이 흥건하게 젖어있어요',
        '장착 방법이 너무 복잡해서 다른 차로 옮겨 설치할 때마다 너무 힘들어요',
        '생후 180일 8.5kg 아기인데 카시트가 벌써 꽉 끼는 느낌이라 고민이에요',
        '주말마다 부모님 댁에 가느라 편도로 2시간 이상 장거리 이동이 잦아요',
        '소형 차종이라 카시트를 설치해도 뒷좌석 공간이 너무 좁지 않았으면 해요',
        '승하차가 편하도록 360도 회전이 부드럽게 되는 모델이 꼭 필요해요',
        '신생아부터 주니어 전까지 오래 사용할 수 있는 안전한 제품을 찾아요',
        '여름에 아기가 덥지 않게 통풍 기능이나 쿨링 시트가 잘 되어 있으면 해요',
      ],
      stroller: [
        '디럭스라 너무 무거워서 혼자 아기 데리고 나갈 때 들고 계단 오르기 힘들어요',
        '바퀴 충격 흡수가 안 되는지 보도블록만 지나가도 아기가 너무 흔들려요',
        '폴딩이 한 번에 안 되고 자꾸 걸려서 차 트렁크에 실을 때마다 진땀 빼요',
        '생후 120일 된 아기인데 이제 디럭스에서 절충형으로 바꾸려 고민 중이에요',
        '지하철이나 버스 이용이 잦아서 개찰구를 통과하기 편한 폭이 좁은 모델 원해요',
        '엘리베이터가 없는 3층 빌라에 거주 중이라 무조건 가벼운 게 최우선이에요',
        '아이와 눈을 맞추며 주행할 수 있도록 양대면 전환이 쉬운 제품을 찾아요',
        '좁은 현관에 보관해야 해서 접었을 때 부피를 적게 차지했으면 좋겠어요',
        '짐 바구니가 넉넉해서 시장을 보거나 기저귀 가방 넣기 편한 거 필요해요',
      ],
      diaper: [
        '밤에 통잠을 자는데 기저귀 흡수력이 부족한지 아침마다 옷이 젖어있어요',
        '피부가 유난히 예민해서 조금만 늦게 갈아줘도 금방 발진이 올라와요',
        '기저귀가 너무 두껍고 빳빳해서 아기가 움직일 때마다 불편해하는 게 보여요',
        '생후 200일 9.5kg 꿀벅지 여아인데 4단계가 작고 5단계는 큰 것 같아요',
        '뒤집기를 시작해서 활동량이 엄청나게 늘어난 에너자이저 아기예요',
        '가족력이 있어서 성분에 민감한데 화학 성분 없는 친환경 제품 찾아요',
        '뭉침 현상이 적고 소변을 본 후에도 보송보송함이 오래 유지되면 좋겠어요',
        '허리 밴드가 신축성이 좋아서 아기가 밥 먹은 후에도 배가 편안했으면 해요',
        '장기적으로 계속 써야 하니 품질이 보장되면서 장당 가격이 합리적인 거 원해요',
      ],
    };

    const fallbackExamples = defaultExamples[category] || [
      // 유형 A: 불편/문제점
      '지금 쓰는 게 불편해요',
      '사용하기 어려워요',
      '품질이 아쉬워요',
      // 유형 B: 아기/가족 상황
      '3개월 아기예요',
      '첫 아이라 잘 몰라요',
      '맞벌이라 시간이 부족해요',
      // 유형 C: 원하는 특징
      '가성비가 중요해요',
      '사용 편한 게 필요해요',
      '안전한 제품을 원해요',
    ];

    const examples = parsed.examples || [];
    while (examples.length < 6) {
      examples.push(fallbackExamples[examples.length] || fallbackExamples[examples.length % fallbackExamples.length]);
    }

    console.log('🎯 Generated context examples for', categoryName, ':', examples);

    return NextResponse.json({ examples: examples.slice(0, 6) });

  } catch (error) {
    console.error('Generate context examples error:', error);
    return NextResponse.json({
      examples: [
        // 유형 A: 불편/문제점
        '지금 쓰는 게 불편해요',
        '사용하기 어려워요',
        '품질이 아쉬워요',
        // 유형 B: 아기/가족 상황
        '3개월 아기예요',
        '첫 아이라 잘 몰라요',
        '맞벌이라 시간이 부족해요',
        // 유형 C: 원하는 특징
        '가성비가 중요해요',
        '사용 편한 게 필요해요',
        '안전한 제품을 원해요',
      ],
    });
  }
}
