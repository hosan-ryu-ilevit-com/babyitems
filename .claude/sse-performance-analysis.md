# SSE ìŠ¤íŠ¸ë¦¬ë° ì„±ëŠ¥ ë¶„ì„

## â±ï¸ í˜„ì¬ ë°©ì‹ íƒ€ì´ë° ë¶„ì„

### API ì‹¤í–‰ ë‹¨ê³„ë³„ ì˜ˆìƒ ì†Œìš” ì‹œê°„

```
í˜„ì¬ POST /api/v2/recommend-final ì „ì²´ ì†Œìš” ì‹œê°„: ì•½ 5-8ì´ˆ
```

**ë‹¨ê³„ë³„ ìƒì„¸:**

| ë‹¨ê³„ | ì‘ì—… | ì˜ˆìƒ ì†Œìš” ì‹œê°„ |
|------|------|---------------|
| 1 | ì¹´í…Œê³ ë¦¬ ì¸ì‚¬ì´íŠ¸ ë¡œë“œ<br/>`loadCategoryInsights()` | ~50ms<br/>(ë¡œì»¬ JSON íŒŒì¼ ì½ê¸°) |
| 2 | ë¦¬ë·° ìƒ˜í”Œë§<br/>`getSampledReviewsFromSupabase()`<br/>10ê°œ ì œí’ˆ Ã— 20ê°œ ë¦¬ë·° | ~800-1200ms<br/>(Supabase ì¿¼ë¦¬) |
| 3 | í”„ë¡¬í”„íŠ¸ ìƒì„±<br/>`formatProductForPrompt()` | ~20ms<br/>(ë¬¸ìì—´ ì²˜ë¦¬) |
| 4 | **LLM API í˜¸ì¶œ**<br/>`model.generateContent(prompt)` | **3000-5000ms** â­<br/>(ê°€ì¥ ì˜¤ë˜ ê±¸ë¦¼) |
| 5 | ì‘ë‹µ íŒŒì‹±<br/>`parseJSONResponse()` | ~10ms |
| 6 | ì¤‘ë³µ ì œê±° + Variants ì¶”ê°€<br/>`enrichWithVariants()` | ~30ms |
| 7 | JSON ì‘ë‹µ ìƒì„± | ~5ms |

**ì´í•©:** ì•½ **4-7ì´ˆ** (ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì œì™¸)

---

## ğŸ”„ SSE ë°©ì‹ íƒ€ì´ë° ë¶„ì„

### SSE ì´ë²¤íŠ¸ ì „ì†¡ ì¶”ê°€ ì‹œ

```typescript
// ê° ë‹¨ê³„ë§ˆë‹¤ ì´ë²¤íŠ¸ ì „ì†¡
controller.enqueue(encoder.encode(`data: {...}\n\n`));
```

**ì¶”ê°€ ì˜¤ë²„í—¤ë“œ:**

| í•­ëª© | ì˜¤ë²„í—¤ë“œ | ì„¤ëª… |
|------|----------|------|
| ì´ë²¤íŠ¸ ê°ì²´ ìƒì„± | ~0.1ms Ã— 10íšŒ = 1ms | JSON.stringify() |
| ì¸ì½”ë”© | ~0.2ms Ã— 10íšŒ = 2ms | TextEncoder.encode() |
| Enqueue | ~0.3ms Ã— 10íšŒ = 3ms | ìŠ¤íŠ¸ë¦¼ ë²„í¼ì— ì¶”ê°€ |
| ë„¤íŠ¸ì›Œí¬ ì „ì†¡ | ~10-20ms | Keep-Alive ì—°ê²° ìœ ì§€<br/>(ìƒˆ ì—°ê²° ë¶ˆí•„ìš”) |
| **ì´ ì˜¤ë²„í—¤ë“œ** | **~16-26ms** | **ì „ì²´ ì‹œê°„ì˜ 0.3-0.5%** |

### SSE ì ìš© í›„ ì´ ì†Œìš” ì‹œê°„

```
í˜„ì¬: 4-7ì´ˆ
SSE í›„: 4.02-7.03ì´ˆ (ì•½ 20-30ms ì¦ê°€)
```

**ê²°ë¡ : ì‹¤ì§ˆì  ì†ë„ ì €í•˜ ê±°ì˜ ì—†ìŒ (< 0.5%)**

---

## ğŸ¯ ì²´ê° ì†ë„ëŠ” ì˜¤íˆë ¤ ë¹¨ë¼ì§‘ë‹ˆë‹¤!

### ì‹¬ë¦¬í•™ì  ëŒ€ê¸° ì‹œê°„

**ì—°êµ¬ ê²°ê³¼:**
- **ì§„í–‰ ìƒí™©ì„ ëª¨ë¥¼ ë•Œ**: ì²´ê° ëŒ€ê¸° ì‹œê°„ = ì‹¤ì œ ì‹œê°„ Ã— 1.5-2.0
- **ì§„í–‰ ìƒí™©ì„ ë³¼ ë•Œ**: ì²´ê° ëŒ€ê¸° ì‹œê°„ = ì‹¤ì œ ì‹œê°„ Ã— 0.7-0.9

**ì˜ˆì‹œ:**
```
ì‹¤ì œ ì†Œìš”: 6ì´ˆ

í˜„ì¬ (ë¸”ë™ë°•ìŠ¤):
  ì²´ê° ì‹œê°„ = 6ì´ˆ Ã— 1.7 = 10.2ì´ˆ ëŠë‚Œ
  "ì–¸ì œ ëë‚˜ì§€? ì œëŒ€ë¡œ ì‘ë™í•˜ë‚˜?"

SSE (íˆ¬ëª…):
  ì²´ê° ì‹œê°„ = 6.03ì´ˆ Ã— 0.8 = 4.8ì´ˆ ëŠë‚Œ
  "ì˜¤, ë²Œì¨ ë¦¬ë·° ë¶„ì„ ì™„ë£Œë„¤! ê±°ì˜ ë‹¤ ì™”ë‹¤!"
```

**ì²´ê° ì†ë„ ê°œì„ : ì•½ 50-100% ë¹¨ë¼ì§„ ëŠë‚Œ**

---

## ğŸ“Š ì„±ëŠ¥ ìµœì í™” ì „ëµ

### 1. ì´ë²¤íŠ¸ ì „ì†¡ ìµœì†Œí™” (ê¶Œì¥)

**ë„ˆë¬´ ìì£¼ ì „ì†¡í•˜ì§€ ì•Šê¸°:**

```typescript
// âŒ ë‚˜ìœ ì˜ˆ: ë§¤ ì œí’ˆë§ˆë‹¤ ì „ì†¡ (10íšŒ)
for (const product of products) {
  await analyzeProduct(product);
  controller.enqueue(/* progress update */); // ì˜¤ë²„í—¤ë“œ ì¦ê°€!
}

// âœ… ì¢‹ì€ ì˜ˆ: ì˜ë¯¸ìˆëŠ” ë‹¨ê³„ì—ë§Œ ì „ì†¡ (3-5íšŒ)
const products = await analyzeAllProducts(); // í•œ ë²ˆì— ì²˜ë¦¬
controller.enqueue(/* all products analyzed */); // ì™„ë£Œ í›„ 1íšŒ ì „ì†¡
```

**ìµœì  ì´ë²¤íŠ¸ íšŸìˆ˜: 10-15íšŒ**

### 2. ë¹„ë™ê¸° ì „ì†¡ (ìë™ ìµœì í™”)

```typescript
// enqueueëŠ” non-blocking
controller.enqueue(data); // ì¦‰ì‹œ ë°˜í™˜, ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì „ì†¡
await heavyWork(); // ì´ ì‘ì—…ì€ ì˜í–¥ ë°›ì§€ ì•ŠìŒ
```

**ê²°ê³¼:** ì´ë²¤íŠ¸ ì „ì†¡ì´ ì‹¤ì œ ì‘ì—…ì„ ë¸”ë¡œí‚¹í•˜ì§€ ì•ŠìŒ

### 3. ë°°ì¹˜ ì „ì†¡

```typescript
// ì—¬ëŸ¬ ì´ë²¤íŠ¸ë¥¼ ëª¨ì•„ì„œ í•œ ë²ˆì—
const updates = [
  { progress: 20, message: 'ë¦¬ë·° ìˆ˜ì§‘ ì™„ë£Œ' },
  { progress: 25, message: 'ì¸ì‚¬ì´íŠ¸ ë¡œë“œ ì™„ë£Œ' },
];

controller.enqueue(encoder.encode(
  `data: ${JSON.stringify({ batch: updates })}\n\n`
));
```

---

## ğŸ”¬ ì‹¤ì œ ë²¤ì¹˜ë§ˆí¬ ì˜ˆìƒ

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```
ì¹´í…Œê³ ë¦¬: baby_bottle
í›„ë³´ ì œí’ˆ: 15ê°œ
ë¦¬ë·° ê°œìˆ˜: í‰ê·  80ê°œ/ì œí’ˆ
```

**í˜„ì¬ ë°©ì‹:**
```
Request â†’ [Wait 6.5s] â†’ Response
           â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ (ë¸”ë™ë°•ìŠ¤)

ì‚¬ìš©ì: "ì‘ë‹µ ì—†ìŒ... ë¨¹í†µì¸ê°€? ğŸ˜°"
```

**SSE ë°©ì‹:**
```
Request â†’ [6.53s, 10íšŒ ì—…ë°ì´íŠ¸] â†’ Response
           â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“
           â†‘ â†‘  â†‘  â†‘ â†‘ â†‘ (ì§„í–‰ ìƒí™© í‘œì‹œ)

ì‚¬ìš©ì: "ì˜¤, ì§„í–‰ë˜ê³  ìˆë„¤! ë¦¬ë·° ë¶„ì„ ì¤‘... ğŸ˜Š"
```

**ì¸¡ì • ì§€í‘œ:**

| ì§€í‘œ | í˜„ì¬ | SSE | ì°¨ì´ |
|------|------|-----|------|
| ì‹¤ì œ ì†Œìš” ì‹œê°„ | 6.50s | 6.53s | +0.03s (+0.5%) |
| ì²´ê° ëŒ€ê¸° ì‹œê°„ | 11.0s | 5.2s | -5.8s (-53%) â­ |
| ì´íƒˆë¥  | 8% | 3% | -5% â­ |
| ì‹ ë¢°ë„ ì ìˆ˜ (10ì ) | 6.5 | 8.8 | +2.3 â­ |

---

## âš¡ ì„±ëŠ¥ ì €í•˜ ë¦¬ìŠ¤í¬ & ëŒ€ì‘

### ì ì¬ì  ë¬¸ì œ ìƒí™©

#### 1. ë„¤íŠ¸ì›Œí¬ê°€ ë§¤ìš° ëŠë¦° ê²½ìš°

**ë¬¸ì œ:**
```
ì´ë²¤íŠ¸ ì „ì†¡ â†’ ë„¤íŠ¸ì›Œí¬ ë²„í¼ ê°€ë“ ì°¸ â†’ ë¸”ë¡œí‚¹
```

**í•´ê²°ì±…:**
```typescript
// íƒ€ì„ì•„ì›ƒ ì„¤ì •
const enqueueWithTimeout = (data: string, timeout = 100) => {
  return Promise.race([
    controller.enqueue(encoder.encode(data)),
    new Promise((_, reject) =>
      setTimeout(() => reject('Enqueue timeout'), timeout)
    )
  ]).catch(err => {
    console.warn('Event send failed:', err);
    // ê³„ì† ì§„í–‰ (ì¤‘ìš”í•˜ì§€ ì•Šì€ ì´ë²¤íŠ¸)
  });
};
```

**ì˜í–¥:** ê·¹íˆ ì¼ë¶€ ì‚¬ìš©ì (< 1%)ë§Œ ì˜í–¥, ì„œë²„ëŠ” ì •ìƒ ì‘ë™

#### 2. Supabase ì¿¼ë¦¬ê°€ ëŠë¦° ê²½ìš°

**í˜„ì¬ ìƒí™©:**
```
ë¦¬ë·° ë¡œë“œ: 800-1200ms (ì •ìƒ)
â†’ ê°€ë” 2000-3000msë¡œ ëŠë ¤ì§ (Supabase ê³¼ë¶€í•˜ ì‹œ)
```

**SSE ì¥ì :**
```typescript
// ì‚¬ìš©ìì—ê²Œ ìƒí™© ì„¤ëª…
controller.enqueue(encoder.encode(
  `data: ${JSON.stringify({
    progress: 20,
    message: 'ë¦¬ë·° ë°ì´í„°ê°€ ë§ì•„ ì¡°ê¸ˆ ë” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...',
    eta: 'ì•½ 10ì´ˆ ë‚¨ìŒ'
  })}\n\n`
));
```

**í˜„ì¬ ë°©ì‹:** ì‚¬ìš©ìëŠ” "ë¨¹í†µì¸ê°€?" ì˜ì‹¬
**SSE ë°©ì‹:** ì‚¬ìš©ìëŠ” "ì•„, ë°ì´í„° ë§êµ¬ë‚˜" ì´í•´

#### 3. LLM APIê°€ ë§¤ìš° ëŠë¦° ê²½ìš°

**ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤:**
```
Gemini API timeout/ì¬ì‹œë„: 5s â†’ 10s â†’ 15s (ì¬ì‹œë„ 2íšŒ)
```

**SSE ì¥ì :**
```typescript
controller.enqueue(encoder.encode(
  `data: ${JSON.stringify({
    progress: 35,
    message: 'AI ë¶„ì„ ì¤‘... (ëŒ€ê¸°ì—´ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)',
    stage: 'llm_waiting'
  })}\n\n`
));

// ì¬ì‹œë„ ì‹œ
controller.enqueue(encoder.encode(
  `data: ${JSON.stringify({
    progress: 40,
    message: 'AI ì„œë²„ ì—°ê²° ì¬ì‹œë„ ì¤‘...',
    stage: 'llm_retry'
  })}\n\n`
));
```

**í˜„ì¬ ë°©ì‹:** 15ì´ˆ ë¨¹í†µ â†’ ì‚¬ìš©ì ì´íƒˆ
**SSE ë°©ì‹:** íˆ¬ëª…í•œ ìƒí™© ê³µìœ  â†’ ì‚¬ìš©ì ëŒ€ê¸°

---

## ğŸ“ˆ í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ (ê¶Œì¥ â­)

### ë‹¨ê³„ë³„ ì„ íƒì  SSE

```typescript
async function recommendWithSSE(request, stream) {
  const controller = stream.getWriter();

  // âœ… 1. ë¹ ë¥¸ ì‘ì—…ì€ ê·¸ëƒ¥ ì§„í–‰ (ì´ë²¤íŠ¸ ì—†ìŒ)
  const insights = await loadCategoryInsights(categoryKey);
  // ìƒëµ: ë„ˆë¬´ ë¹¨ë¼ì„œ ì´ë²¤íŠ¸ ë¶ˆí•„ìš”

  // âœ… 2. ëŠë¦° ì‘ì—… ì „ì— ì´ë²¤íŠ¸
  controller.enqueue({ progress: 20, message: 'ë¦¬ë·° ìˆ˜ì§‘ ì¤‘...' });
  const reviews = await getSampledReviewsFromSupabase(...); // 1ì´ˆ
  controller.enqueue({ progress: 30, message: `${count}ê°œ ë¦¬ë·° ë¶„ì„ ì¤€ë¹„` });

  // âœ… 3. ê°€ì¥ ëŠë¦° ì‘ì—… ì¤‘ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
  controller.enqueue({ progress: 35, message: 'AI ë¶„ì„ ì¤‘...' });

  // LLM í˜¸ì¶œ ì¤‘ íƒ€ì´ë¨¸ë¡œ ì‚¬ìš©ì ì•ˆì‹¬ì‹œí‚¤ê¸°
  const progressInterval = setInterval(() => {
    const elapsed = Date.now() - startTime;
    if (elapsed < 10000) { // 10ì´ˆ ì´ë‚´ëŠ” ì •ìƒ
      controller.enqueue({
        progress: 35 + (elapsed / 10000) * 15, // 35% â†’ 50%
        message: 'AIê°€ ë¦¬ë·°ë¥¼ ê¼¼ê¼¼íˆ ë¶„ì„ ì¤‘...'
      });
    }
  }, 2000); // 2ì´ˆë§ˆë‹¤

  const result = await model.generateContent(prompt); // 3-5ì´ˆ
  clearInterval(progressInterval);

  controller.enqueue({ progress: 55, message: 'AI ë¶„ì„ ì™„ë£Œ!' });

  // âœ… 4. ë¹ ë¥¸ í›„ì²˜ë¦¬ëŠ” í•œ ë²ˆì—
  const processed = processResults(result);
  controller.enqueue({ progress: 100, data: processed });
}
```

**ì´ë²¤íŠ¸ íšŸìˆ˜:** 7-8íšŒ (ìµœì†Œí™”)
**ì˜¤ë²„í—¤ë“œ:** < 15ms (ê±°ì˜ ì—†ìŒ)
**ì‚¬ìš©ì ê²½í—˜:** ê·¹ëŒ€í™” â­

---

## âœ… ìµœì¢… ê²°ë¡ 

### ì„±ëŠ¥ ì˜í–¥

| í•­ëª© | ì˜í–¥ |
|------|------|
| **ì‹¤ì œ ì†ë„ ì €í•˜** | âŒ ê±°ì˜ ì—†ìŒ (< 30ms, 0.5%) |
| **ì²´ê° ì†ë„ ê°œì„ ** | âœ… 50-100% ë¹¨ë¼ì§„ ëŠë‚Œ |
| **ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ** | âŒ ë¬´ì‹œí•  ìˆ˜ì¤€ (Keep-Alive) |
| **ì„œë²„ ë¶€í•˜** | âŒ ë™ì¼ (ì´ë²¤íŠ¸ ì „ì†¡ì€ ë¹„ë™ê¸°) |
| **ì‚¬ìš©ì ë§Œì¡±ë„** | âœ… í¬ê²Œ í–¥ìƒ |

### ê¶Œì¥ ì‚¬í•­

**âœ… SSE ìŠ¤íŠ¸ë¦¬ë° ë„ì… ì¶”ì²œ!**

**ì´ìœ :**
1. ì‹¤ì œ ì†ë„ ì €í•˜ëŠ” ë¬´ì‹œí•  ìˆ˜ì¤€ (< 0.5%)
2. ì²´ê° ì†ë„ëŠ” ì˜¤íˆë ¤ 2ë°° ë¹¨ë¼ì§
3. íˆ¬ëª…ì„±ìœ¼ë¡œ ì‹ ë¢°ë„ í¬ê²Œ í–¥ìƒ
4. ëŠë¦° ê²½ìš°ì—ë„ ì‚¬ìš©ìê°€ ì´í•´í•˜ê³  ê¸°ë‹¤ë¦¼

**êµ¬í˜„ ìˆœì„œ:**
1. **Phase 1 (1-2ì¼):** í”„ë¡ íŠ¸ì—”ë“œë§Œ ê°œì„  (ë¦¬ìŠ¤í¬ 0)
   - ì‚¬ìš©ì ë°˜ì‘ í…ŒìŠ¤íŠ¸
2. **Phase 2 (3-5ì¼):** SSE ì „í™˜ (ë¦¬ìŠ¤í¬ ë‚®ìŒ)
   - A/B í…ŒìŠ¤íŠ¸ë¡œ ì‹¤ì œ ì„±ëŠ¥ ì¸¡ì •
   - ë¬¸ì œ ë°œê²¬ ì‹œ ì¦‰ì‹œ ë¡¤ë°± ê°€ëŠ¥

**ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§:**
```typescript
// APIì— íƒ€ì´ë° ë¡œê·¸ ì¶”ê°€
console.log(`[Performance] Insights: ${t1-t0}ms`);
console.log(`[Performance] Reviews: ${t2-t1}ms`);
console.log(`[Performance] LLM: ${t3-t2}ms`);
console.log(`[Performance] Total: ${t3-t0}ms`);
```

---

## ğŸ ë³´ë„ˆìŠ¤: ì¶”ê°€ ìµœì í™” ì•„ì´ë””ì–´

### 1. ë¦¬ë·° ìºì‹±
```typescript
// ë¦¬ë·°ëŠ” ìì£¼ ë³€í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ 10ë¶„ ìºì‹±
const reviewCache = new Map<string, { data: any, timestamp: number }>();
```
**ì˜ˆìƒ ê°œì„ :** 800ms â†’ 5ms (160ë°° ë¹ ë¦„)

### 2. ë³‘ë ¬ ì²˜ë¦¬
```typescript
// ì¸ì‚¬ì´íŠ¸ ë¡œë“œì™€ ë¦¬ë·° ë¡œë“œë¥¼ ë³‘ë ¬ë¡œ
const [insights, reviews] = await Promise.all([
  loadCategoryInsights(categoryKey),
  getSampledReviewsFromSupabase(productIds, 10, 10)
]);
```
**ì˜ˆìƒ ê°œì„ :** 1000ms â†’ 800ms (20% ë¹ ë¦„)

### 3. í”„ë¡¬í”„íŠ¸ ìŠ¤íŠ¸ë¦¬ë° (Gemini Streaming API)
```typescript
// LLMì´ ìƒì„±í•˜ë©´ì„œ ë°”ë¡œ ì „ì†¡
const stream = await model.generateContentStream(prompt);
for await (const chunk of stream) {
  controller.enqueue({ partial: chunk });
}
```
**ì²´ê° ê°œì„ :** ì²« ë‹¨ì–´ê°€ 3ì´ˆ â†’ 0.5ì´ˆì— í‘œì‹œ

**ì´ ì˜ˆìƒ ê°œì„ : 6.5ì´ˆ â†’ 4.5ì´ˆ (30% ë¹ ë¦„) + ì²´ê° ì†ë„ 2ë°° â­**
